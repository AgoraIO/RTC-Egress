# Restful API Design

## Start Task

### (Native) curl -X POST http://localhost:8091/egress/v1/{app_id}/tasks \
    -H "Content-Type: application/json" \
    -d '{
      "request_id": "m2d3k03l",
      "cmd": "record",
      "payload": {
        "layout": "flat",
        "channel": "egress_test",
        "access_token": "007eJxt9VMp+//+i9SOE",
        "workerUid": 42,
        "users": ["user1", "user2"],
        "filename_pattern": "file_output", // Support regexp(date, time, region)
        "format": "hls",
        "video": {
            "width": 1280,
            "height": 720,
            "frameRate": 30,
            "bitrate": 1000
        },
        "audio": {
            "sampleRate": 48000,
            "channels": 2,
            "bitrate": 128
        }
      }
    }'

### (Web) curl -X POST http://localhost:8091/egress/v1/{app_id}/tasks \
    -H "Content-Type: application/json" \
    -d '{
      "request_id": "m2d3kw3l",
      "cmd": "record",
      "payload": {
        "layout": "freestyle",
        "url": "http://your_freestyle_canvas.good.example",
        "filename_pattern": "file_output", // Support regexp(date, time, region)
        "webGL": false,
        "format": "hls",
        "video": {
            "width": 1280,
            "height": 720,
            "frameRate": 30,
            "bitrate": 1000
        },
        "audio": {
            "sampleRate": 48000,
            "channels": 2,
            "bitrate": 128
        }
      }
    }'

### Response
    {
        "request_id": "m2d3k03l",
        "task_id": "1ta5k3552",
        "status": "enqueued"
    }

## Stop Task

### curl -X POST http://localhost:8091/egress/v1/{app_id}/tasks/{task_id}/stop \
    -H "Content-Type: application/json" \
    -d '{
      "request_id": "234drd3"
    }'

### Response

```json
{
  "request_id": "234drd3",
  "status": "enqueued",
  "message": "Stop task enqueued for task 1ta5k3552", // Stop accepted; manager will set STOPPING when picked up
}
```

Notes
- The manager sets the original task to STOPPING when it actually picks up and processes
  the stop task. In fast paths you may observe PROCESSING â†’ STOPPED directly.
- Track the terminal state (STOPPED/FAILED/TIMEOUT) of the target task id.

## Get Task Status

### curl -X POST http://localhost:8091/egress/v1/{app_id}/tasks/{task_id}/status \
    -H "Content-Type: application/json" \
    -d '{
      "request_id": "1yu323k5"
    }'

### Response

```json
{
  "request_id": "1yu323k5",
  "task_id": "92347f6bdf0465b3",
  "state": "PROCESSING",           // One of: ENQUEUED, PROCESSING, STOPPING, STOPPED, FAILED, TIMEOUT
  "action": "start|stop|status",   // Last command processed for this task id
  "created_at": "2025-09-19T00:15:15Z",
  "error": "",                     // Error message when state is FAILED
  "payload": {
        "layout": "flat",
        "channel": "egress_test",
        "users": ["user1", "user2"],
        "files": ["file_output", "file_output2"], // Files generated by this task
        "format": "hls",
        "video": {
            "width": 1280,
            "height": 720,
            "frameRate": 30,
            "bitrate": 1000
        },
        "audio": {
            "sampleRate": 48000,
            "channels": 2,
            "bitrate": 128
        }
    }
}
```

## Task States

- ENQUEUED: Task accepted and queued for processing.
- PROCESSING: Manager has claimed the task with a lease.
- STOPPING: Manager picked up a stop command for the original task and is stopping it.
- STOPPED: Terminal, expected. Use reason/message to distinguish completed vs user_stop.
- FAILED: Terminal, abnormal (unrecoverable error).
- TIMEOUT: Terminal, abnormal (aged out while enqueued).
