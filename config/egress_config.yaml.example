# Egress Configuration - Native Recording/Snapshot .etc
# This service consumes native recording tasks from Redis and processes them with C++ eg_workers

pod:
  region: "us-west-1" # Pod region for task queue routing
  workers: 4          # Number of eg_worker processes

server:
  health_port: 8192   # Health check port

# Redis Configuration
redis:
  addr: "localhost:6379"     # Redis server address
  password: ""               # Redis password (leave empty if no password)
  db: 0                      # Redis database number
  task_ttl: 172800           # Task TTL in seconds (48 hours)
  worker_patterns:           # Native worker subscription patterns
    - "egress:snapshot:*"    # Global native snapshot tasks
    - "egress:record:*"      # Global native recording tasks
    - "egress:*:snapshot:*"  # Regional native snapshot tasks
    - "egress:*:record:*"    # Regional native recording tasks

# Agora Configuration
agora:
  app_id: ""
  channel_name: ""
  access_token: ""
  egress_uid: ""
  rtc_timeout: 10            # RTC connection timeout in seconds

# Snapshots settings
snapshots:
  output_dir: "./snapshots"  # Where to store snapshots (relative to the working directory for default)
  width: 1280                # Video width
  height: 720                # Video height
  users: ""                  # target user list, if multiple users, use comma to separate
  layout: "flat"             # Recording layout: "grid" or "flat" or "spotlight" or "freestyle" or "customized-layout"
  interval_in_ms: 20000      # Save frame every 20 seconds
  quality: 90                # Picture quality(0 for AUTO, 1-100)

# Recording settings
recording:
  output_dir: "./recordings"   # Where to store recordings
  users: ""                    # target user list, if multiple users, use comma to separate
  layout: "flat"               # Recording layout: "grid" or "flat" or "spotlight" or "freestyle" or "customized-layout"
  format: "ts"                 # Output format: "mp4", "avi", "mkv", "ts"
  max_duration_seconds: 86400  # Maximum recording duration (1 day)

  # Video recording settings
  video:
    enabled: true            # Enable video recording
    width: 1280              # Video width
    height: 720              # Video height
    fps: 30                  # Video frame rate
    bitrate: 2000000         # Video bitrate in bps (2 Mbps)
    codec: "libx264"         # Video codec
    buffer_size: 30          # Video frame buffer size

  # Audio recording settings
  audio:
    enabled: true        # Enable audio recording
    sample_rate: 48000   # Audio sample rate in Hz (target output)
    channels: 2          # Number of audio channels (target output)
    bitrate: 128000      # Audio bitrate in bps (128 kbps)
    codec: "aac"         # Audio codec
    buffer_size: 100     # Audio frame buffer size

  # Only works when format is "ts"
  ts:
    segment_duration: 6         # Duration of each TS segment in seconds
    generate_playlist: true     # Generate HLS playlist (m3u8 file)
    keep_incomplete_segments: true # Keep incomplete segments on crash/interruption

# Logging configuration
log:
  level: "info"            # debug, info, warn, error, fatal, panic
  path: "./logs/rtc_egress"
  max_size: 100           # Max log file size in MB
  max_backups: 3           # Maximum number of old log files to retain
  max_age: 28              # Maximum number of days to retain old log files

# Advanced settings
advanced:
  # Buffer settings for video processing
  video_buffer_size: 10     # Number of frames to buffer
  audio_buffer_size: 50     # Number of audio frames to buffer

  # Performance settings
  gpu_acceleration: false   # Enable GPU acceleration if available
  thread_pool_size: 4       # Number of worker threads for processing

# Environment variable overrides:
# REDIS_ADDR, REDIS_PASSWORD, POD_REGION, POD_WORKERS, APP_ID
